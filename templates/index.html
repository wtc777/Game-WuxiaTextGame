<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>江湖见：武侠文字冒险</title>
  <!-- Google Fonts for Chinese serif style -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#161616;
      --paper:#f5f1e6;
      --gold:#c7a86a;
      --jade:#2f6f5e;
      --crimson:#8e2d2b;
      --smoke:rgba(0,0,0,.45);
      --ink-2:#222;
      --paper-2:#efe9da;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Noto Serif SC",serif;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg,#0c1118,#171a20 60%, #1d2127);
      color:#eee;
    }
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:24px 16px 64px;
      position:relative;
    }
    /* Header */
    .header{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
      margin:8px 0 20px;
      position:relative;
    }
    .seal{
      width:64px;height:64px;border-radius:12px;
      background:linear-gradient(145deg,#b73730,#801f1c);
      box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 2px 0 rgba(255,255,255,.15);
      display:grid;place-items:center;
      color:#f7e5cf;
      font-weight:700;
      letter-spacing:.2em;
    }
    .title{
      font-size: clamp(26px, 4.6vw, 44px);
      line-height:1.1;
      letter-spacing:.06em;
      text-shadow:0 1px 0 #000, 0 10px 40px rgba(0,0,0,.45);
    }
    .subtitle{
      text-align:center;
      color:#c7c7c7;
      margin-top:4px;
      font-size:14px;
      letter-spacing:.12em;
    }

    /* Scroll panel (paper texture) */
    .scroll{
      border:1px solid rgba(199,168,106,.25);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), transparent 30%),
        repeating-linear-gradient(90deg, rgba(0,0,0,.08) 0 1px, transparent 1px 12px),
        radial-gradient(1100px 400px at 50% -50%, rgba(255,255,255,.08), transparent 40%),
        linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,0) 55%),
        linear-gradient(0deg, #fff0 0%, #fff0 75%, rgba(255,255,255,.04) 100%);
      background-color:#14161b;
      border-radius:14px;
      padding:18px;
      box-shadow:
        0 20px 40px rgba(0,0,0,.35),
        inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .scroll--accent{ border-color: rgba(143, 114, 66, .45); }

    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr; }
    }

    /* Sidebar (player card) */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .card h3{
      margin:0 0 10px;
      font-size:18px;
      color:var(--gold);
      letter-spacing:.2em;
    }
    .row{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:6px 0;}
    .label{color:#cbbfa5; font-size:13px; letter-spacing:.08em;}
    .value{font-weight:700; color:#f2e9d8;}
    .bar{height:12px; background:#2a2e35; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .bar>span{display:block;height:100%; background:linear-gradient(90deg,#b23a33,#de9b43);}

    /* Buttons */
    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .btn{
      border:none; cursor:pointer;
      background:linear-gradient(145deg, rgba(199,168,106,.9), rgba(118,93,45,.95));
      color:#1a1712; font-weight:700; letter-spacing:.1em;
      padding:10px 16px; border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.3);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn:hover{ transform:translateY(-2px); filter:brightness(1.04) }
    .btn:active{ transform:translateY(0) scale(.98) }
    .btn--ghost{
      background:transparent; color:#e9d9b6;
      border:1px solid rgba(199,168,106,.45);
      box-shadow:none;
    }
    .btn--danger{
      background:linear-gradient(145deg, #b33d3a, #6f1f1c);
      color:#f3e3d2;
    }
    .btn--jade{
      background:linear-gradient(145deg, #3d8c78, #1c4e44);
      color:#e6fff6;
    }

    /* Background cards for backgrounds selection */
    .bg-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .bg-card{
      padding:12px;
      border-radius:12px;
      background:linear-gradient(160deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      min-height:140px;
    }
    .bg-card:hover{ transform:translateY(-3px); border-color: rgba(199,168,106,.45);}
    .bg-card.active{ border-color: var(--gold); box-shadow:0 8px 22px rgba(0,0,0,.28) }
    .bg-name{ color:var(--gold); font-weight:700; margin-bottom:6px; letter-spacing:.12em}
    .bg-desc{ color:#d7d1c5; font-size:13px; line-height:1.45 }
    .bg-stats{ margin-top:8px; color:#9ad0b5; font-size:12px }

    /* Log (scroll look) */
    .log{
      height:320px; overflow:auto; padding:12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.018), rgba(255,255,255,.0)),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 24px);
      border:1px dashed rgba(199,168,106,.35);
      border-radius:12px;
    }
    .log p{
      margin:0 0 10px; padding-left:10px; border-left:3px solid rgba(199,168,106,.6);
      color:#efe9da; line-height:1.6;
    }

    /* Enemy panel */
    .enemy{
      border:1px solid rgba(168,58,58,.65);
      background:linear-gradient(180deg, rgba(142,45,43,.25), rgba(20,0,0,.08));
      padding:12px; border-radius:12px; margin-top:10px;
    }
    .enemy h4{ margin:0 0 8px; color:#f2c9c7; letter-spacing:.16em}

    /* Hidden */
    .hidden{ display:none !important; }

    /* Footer */
    .footer{
      margin-top:18px; text-align:center; color:#bfb8a7; font-size:12px;
      letter-spacing:.16em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="seal">江湖</div>
      <div>
        <div class="title">江湖见 · 武侠文字冒险</div>
        <div class="subtitle">—— 剑胆琴心，行走九州 ——</div>
      </div>
    </div>

    <!-- Character Create Panel -->
    <section id="panel-create" class="scroll scroll--accent">
      <h2 style="margin:0; color:var(--gold); letter-spacing:.22em; font-size:18px;">开篇 · 立名与出身</h2>
      <div class="grid" style="margin-top:12px">
        <div class="card">
          <h3>角色信息</h3>
          <div class="row">
            <span class="label">名号</span>
            <input id="ipt-name" placeholder="请输入江湖名号" style="flex:1; margin-left:10px;
              background:#0f1217; border:1px solid rgba(255,255,255,.08); color:#efe9da; padding:10px 12px; border-radius:10px; font-family:inherit">
          </div>
          <div class="row">
            <span class="label">流派</span>
            <select id="sel-art" style="flex:1; margin-left:10px;
              background:#0f1217; border:1px solid rgba(255,255,255,.08); color:#efe9da; padding:10px 12px; border-radius:10px; font-family:inherit">
              <option value="剑宗">剑宗 - 攻势凌厉</option>
              <option value="拳法">拳法 - 刚猛狠准</option>
              <option value="内功">内功 - 刚柔并济</option>
              <option value="轻功">轻功 - 身法绝伦</option>
            </select>
          </div>
          <div class="actions">
            <button class="btn" id="btn-create">出 发</button>
            <button class="btn btn--ghost hidden" id="btn-load">读取存档</button>
          </div>
          <div id="save-brief" class="footer hidden"></div>
        </div>

        <div>
          <div style="color:#cbbfa5;letter-spacing:.16em; margin-bottom:6px;">选择出身</div>
          <div id="bg-grid" class="bg-grid"></div>
        </div>
      </div>
    </section>

    <!-- Main Game Panel -->
    <section id="panel-game" class="scroll hidden" style="margin-top:14px">
      <div class="grid">
        <!-- Sidebar -->
        <div class="card" id="sidebar">
          <h3>行囊与修为</h3>
          <div class="row"><span class="label">名号</span><span class="value" id="pv-name">-</span></div>
          <div class="row"><span class="label">出身·流派</span><span class="value" id="pv-title">-</span></div>
          <div class="row"><span class="label">等级</span><span class="value" id="pv-lv">-</span></div>
          <div class="row"><span class="label">年龄</span><span class="value" id="pv-age">-</span></div>
          <div class="row"><span class="label">攻击</span><span class="value" id="pv-atk">-</span></div>
          <div class="row"><span class="label">金币</span><span class="value" id="pv-gold">-</span></div>
          <div class="row"><span class="label">武器</span><span class="value" id="pv-weapon">-</span></div>

          <div style="margin-top:10px" class="row">
            <div class="bar" style="width:100%"><span id="bar-hp" style="width:100%"></span></div>
          </div>
          <div class="row"><span class="label">生命</span><span class="value" id="pv-hp">0/0</span></div>

          <div style="margin-top:6px" class="row">
            <div class="bar" style="width:100%"><span id="bar-exp" style="width:0%"></span></div>
          </div>
          <div class="row"><span class="label">经验</span><span class="value" id="pv-exp">0/0</span></div>

          <div class="row" style="margin-top:8px"><span class="label">武林历</span><span class="value" id="pv-time">-</span></div>

          <div class="actions" style="margin-top:12px">
            <button class="btn btn--jade" id="btn-save">保存</button>
            <button class="btn btn--ghost" id="btn-load2">读取</button>
          </div>
        </div>

        <!-- Main -->
        <div>
          <div class="row" style="justify-content:flex-start; gap:10px; margin-bottom:10px">
            <button class="btn" id="btn-explore">行走江湖</button>
            <button class="btn" id="btn-rest">歇脚(10金)</button>
            <button class="btn" id="btn-shop">兵器铺</button>
          </div>

          <div>
            <div style="color:#cbbfa5;letter-spacing:.2em; margin:6px 0 8px;">冒险日志 · 纸上江湖</div>
            <div id="log" class="log">
              <p>初入江湖，且看风云如何起。</p>
            </div>
          </div>

          <!-- Enemy Panel -->
          <div id="enemy" class="enemy hidden">
            <h4>⚔ 战斗中 · <span id="enm-name">-</span></h4>
            <div class="row"><span class="label">生命</span><span class="value" id="enm-hp">-</span></div>
            <div class="row"><span class="label">攻击</span><span class="value" id="enm-atk">-</span></div>
            <div class="actions">
              <button class="btn btn--danger" id="btn-attack">出剑</button>
              <button class="btn btn--ghost" id="btn-flee">脱身</button>
            </div>
          </div>

          <!-- Shop Panel -->
          <div id="shop" class="card hidden" style="margin-top:12px">
            <h3>兵器铺</h3>
            <div id="shop-items"></div>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">© 江湖见 · 武侠文字冒险</div>
  </div>

  <script>
    // --- State ---
    let gameState = "create";
    let selectedBg = "commoner";
    let bgMap = {};
    let inBattle = false;

    const el = (id)=>document.getElementById(id);
    const show = (n)=>el(n).classList.remove("hidden");
    const hide = (n)=>el(n).classList.add("hidden");

    // --- Init ---
    window.addEventListener("load", () => {
      loadBackgrounds();
      checkSave();
      bindEvents();
    });

    function bindEvents(){
      el("btn-create").onclick = createChar;
      el("btn-load").onclick = loadGame;
      el("btn-load2").onclick = loadGame;
      el("btn-save").onclick = saveGame;
      el("btn-explore").onclick = explore;
      el("btn-rest").onclick = rest;
      el("btn-shop").onclick = toggleShop;
      el("btn-attack").onclick = attack;
      el("btn-flee").onclick = flee;
    }

    // --- Backgrounds ---
    async function loadBackgrounds(){
      try{
        const res = await fetch("/get_backgrounds");
        const data = await res.json();
        bgMap = data.backgrounds || {};
        const wrap = el("bg-grid");
        wrap.innerHTML = "";
        Object.entries(bgMap).forEach(([key,bg])=>{
          const div = document.createElement("div");
          div.className = "bg-card";
          if(key===selectedBg) div.classList.add("active");
          div.onclick = ()=> {
            selectedBg = key;
            document.querySelectorAll(".bg-card").forEach(x=>x.classList.remove("active"));
            div.classList.add("active");
          };
          const stats = bg.stats||{hp:0,attack:0,gold:0,exp:0};
          div.innerHTML = `
            <div class="bg-name">${bg.name}</div>
            <div class="bg-desc">${bg.description||""}</div>
            <div class="bg-stats">生命+${stats.hp} 攻击+${stats.attack} 金币+${stats.gold} 经验+${stats.exp}</div>
          `;
          wrap.appendChild(div);
        });
      }catch(e){
        addLog("【系统】出身数据加载失败。");
      }
    }

    // --- Save check ---
    async function checkSave(){
      try{
        const res = await fetch("/get_save_info");
        const data = await res.json();
        if(data.has_save){
          const si = data.save_info;
          el("save-brief").classList.remove("hidden");
          el("save-brief").textContent = `发现存档：${si.name} Lv.${si.level} · ${si.age}岁 · ${new Date(si.timestamp).toLocaleString("zh-CN")}`;
          el("btn-load").classList.remove("hidden");
        }
      }catch(e){}
    }

    // --- Create Character ---
    async function createChar(){
      const name = el("ipt-name").value.trim();
      const martial = el("sel-art").value;
      if(!name) { alert("请先取一个名号。"); return; }
      try{
        const res = await fetch("/create_character",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ name, martial_art: martial, background: selectedBg })
        });
        const data = await res.json();
        if(!data.success){ alert(data.error||"创建失败"); return; }
        addLog(data.message);
        hide("panel-create");
        show("panel-game");
        await refreshStatus();
        gameState = "explore";
      }catch(e){
        alert("网络异常："+e.message);
      }
    }

    // --- Refresh Status ---
    async function refreshStatus(){
      const r = await fetch("/game_status");
      const d = await r.json();
      if(d.error) throw Error(d.error);
      const p = d.player, bg = d.background_info, wp = d.weapon_info;

      el("pv-name").textContent = p.name;
      el("pv-title").textContent = `${(bg.name||"未知出身")} · ${p.martial_art}`;
      el("pv-lv").textContent = p.level;
      el("pv-age").textContent = `${p.age}岁`;
      el("pv-atk").textContent = p.attack;
      el("pv-gold").textContent = p.gold;
      el("pv-weapon").textContent = (wp && wp.name) ? wp.name : "-";

      el("pv-time").textContent = d.time_string;

      const hpPct = Math.max(0, Math.min(100, Math.round(p.hp / Math.max(1,p.max_hp) * 100)));
      el("bar-hp").style.width = hpPct + "%";
      el("pv-hp").textContent = `${p.hp}/${p.max_hp}`;

      const expPct = Math.max(0, Math.min(100, Math.round(p.exp / Math.max(1,p.exp_to_next) * 100)));
      el("bar-exp").style.width = expPct + "%";
      el("pv-exp").textContent = `${p.exp}/${p.exp_to_next}`;

      return d;
    }

    // --- Log helper ---
    function addLog(msg){
      const box = el("log");
      const p = document.createElement("p");
      if(/\[.*\]/.test(msg)) p.innerHTML = msg; else p.textContent = msg;
      box.appendChild(p);
      while(box.children.length>60) box.removeChild(box.firstChild);
      box.scrollTop = box.scrollHeight;
    }

    // --- Explore ---
    async function explore(){
      if(inBattle){ alert("正在战斗中！"); return; }
      try{
        const r = await fetch("/explore",{ method:"POST", headers:{ "Content-Type":"application/json" }});
        const d = await r.json();
        if(d.error){ alert(d.error); return; }
        (d.messages||[]).forEach(addLog);
        if(d.type==="enemy"){
          inBattle = true;
          el("enm-name").textContent = d.enemy.name;
          el("enm-hp").textContent = d.enemy.hp;
          el("enm-atk").textContent = d.enemy.attack;
          show("enemy");
        }else{
          await refreshStatus();
        }
      }catch(e){ alert("探索失败："+e.message); }
    }

    // --- Attack ---
    async function attack(){
      if(!inBattle) return;
      try{
        const r = await fetch("/battle",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ action:"attack" })
        });
        const d = await r.json();
        if(d.error){ alert(d.error); return; }
        (d.battle_log||[]).forEach(addLog);

        if(d.victory || d.defeat){
          inBattle = false;
          hide("enemy");
        }else if(d.continue){
          el("enm-hp").textContent = d.enemy_hp;
        }
        await refreshStatus();
      }catch(e){ alert("出剑失败："+e.message); }
    }

    // --- Flee ---
    async function flee(){
      if(!inBattle) return;
      try{
        const r = await fetch("/battle",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ action:"flee" })
        });
        const d = await r.json();
        if(d.error){ alert(d.error); return; }
        if(d.message) addLog(d.message);
        if(d.fled){
          inBattle = false;
          hide("enemy");
        }else if(typeof d.enemy_hp!=="undefined"){
          el("enm-hp").textContent = d.enemy_hp;
        }
        await refreshStatus();
      }catch(e){ alert("脱身失败："+e.message); }
    }

    // --- Rest ---
    async function rest(){
      if(inBattle){ alert("战斗中不可歇脚！"); return; }
      try{
        const r = await fetch("/rest",{ method:"POST", headers:{ "Content-Type":"application/json" }});
        const d = await r.json();
        if(d.error){ alert(d.error); return; }
        addLog(d.message);
        await refreshStatus();
      }catch(e){ alert("歇脚失败："+e.message); }
    }

    // --- Shop ---
    async function toggleShop(){
      const box = el("shop");
      if(box.classList.contains("hidden")){
        await loadShop();
        show("shop");
      }else{
        hide("shop");
      }
    }
    async function loadShop(){
      try{
        const r = await fetch("/shop");
        const d = await r.json();
        const wrap = el("shop-items");
        wrap.innerHTML = "";
        Object.entries(d.weapons||{}).forEach(([key,w])=>{
          const price = (w.attack||0)*10;
          const item = document.createElement("div");
          item.className = "row";
          item.style.borderTop = "1px dashed rgba(255,255,255,.08)";
          item.style.padding = "10px 0";
          item.innerHTML = `
            <div style="flex:1">
              <div style="color:#e9d9b6; font-weight:700; letter-spacing:.12em">${w.name}</div>
              <div style="font-size:13px; color:#c9c3b6">${w.description||""}</div>
              <div style="font-size:12px; color:#9ad0b5; margin-top:4px">攻击 +${w.attack} · 价格 ${price}</div>
            </div>
            <button class="btn btn--ghost" data-k="${key}">购 入</button>
          `;
          item.querySelector("button").onclick = ()=>buyWeapon(key);
          wrap.appendChild(item);
        });
      }catch(e){ addLog("兵器铺打烊了……"); }
    }
    async function buyWeapon(weaponKey){
      try{
        const r = await fetch("/buy_weapon",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ weapon: weaponKey })
        });
        const d = await r.json();
        if(d.success){
          addLog(d.message);
          await refreshStatus();
          await loadShop();
        }else{
          alert(d.error||"购买失败");
        }
      }catch(e){ alert("购买失败："+e.message); }
    }

    // --- Save / Load ---
    async function saveGame(){
      try{
        const r = await fetch("/save_game",{ method:"POST", headers:{ "Content-Type":"application/json" }});
        const d = await r.json();
        if(d.error){ alert(d.error); return; }
        addLog(`【系统】${d.message} · ${new Date(d.save_time).toLocaleString("zh-CN")}`);
        alert("已保存。");
      }catch(e){ alert("保存失败："+e.message); }
    }
    async function loadGame(){
      try{
        const r = await fetch("/load_game",{ method:"POST", headers:{ "Content-Type":"application/json" }});
        const d = await r.json();
        if(d.error){ alert(d.error); return; }
        addLog(`【系统】${d.message}`);
        hide("panel-create"); show("panel-game");
        await refreshStatus();
        gameState="explore";
        alert("读取成功。");
      }catch(e){ alert("读取失败："+e.message); }
    }
  </script>
</body>
</html>